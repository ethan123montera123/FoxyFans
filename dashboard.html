<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | FoxyFans</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FullCalendar CSS and JS for Calendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBQv0xhSZS0Sv--8ohXsrtME_HLlVTOeLg",
            authDomain: "foxyfans-e9761.firebaseapp.com",
            projectId: "foxyfans-e9761",
            storageBucket: "foxyfans-e9761.firebasestorage.app",
            messagingSenderId: "509215295074",
            appId: "1:509215295074:web:2bb6485985db4b99e2333b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Check if the user is logged in
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html"; // Redirect to login page
            }
        });

        window.logoutUser = async function() {
            try {
                await signOut(auth);
                alert("You have been logged out.");
                window.location.href = "login.html"; // Redirect to login page after logout
            } catch (error) {
                console.error("Error signing out: ", error);
            }
        }

        // Fetch applicants and show available interviews
        window.fetchApplicants = function() {
            const applicationsRef = ref(database, 'applications');
            onValue(applicationsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const applicantSelect = document.getElementById('applicantSelect');
                    applicantSelect.innerHTML = '<option value="">Select Applicant</option>'; // Clear previous options

                    // Populate the dropdown with applicants' names
                    Object.keys(data).forEach((key) => {
                        const applicant = data[key];
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = applicant.name; // Display only the applicant's name
                        applicantSelect.appendChild(option);
                    });
                }
            });
        };

        window.onload = function() {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'en',
                eventClick: function(info) {
                    alert('Applicant: ' + info.event.title + '\nInterview Date: ' + info.event.start.toLocaleString());
                },
                dateClick: function(info) {
                    const selectedDate = info.dateStr;
                    const applicantId = document.getElementById('applicantSelect').value;

                    if (applicantId) {
                        const applicantName = document.getElementById('applicantSelect').selectedOptions[0].text;

                        const applicantData = {
                            name: applicantName,
                            interviewDate: selectedDate
                        };

                        // Save the applicant's interview schedule to Firebase
                        const newInterviewRef = ref(database, 'interviews/' + selectedDate + '-' + applicantId);
                        set(newInterviewRef, applicantData)
                            .then(() => {
                                alert("Interview scheduled successfully!");
                                calendar.addEvent({
                                    title: applicantName,  // Only the applicant's name will appear
                                    start: selectedDate,
                                    backgroundColor: "#FF80AB",  // Custom color
                                    borderColor: "#FF80AB"
                                });
                            })
                            .catch((error) => {
                                console.error("Error scheduling interview: ", error);
                            });
                    } else {
                        alert("Please select an applicant.");
                    }
                }
            });

            // Initialize the calendar
            calendar.render();

            // Fetch applicants and add to dropdown
            fetchApplicants();
        };
    </script>
</head>
<body class="bg-white">

    <div class="flex h-screen">

        <!-- Sidebar -->
        <div class="bg-pink-500 w-64 p-4 text-white flex flex-col justify-between">
            <div>
                <h2 class="text-2xl font-semibold mb-6">FoxyFans Dashboard</h2>
                <nav>
                    <ul>
                        <li><a href="dashboard.html" class="block py-2 px-4 rounded-lg hover:bg-pink-700 mb-2">Home</a></li>
                        <li><a href="applicants.html" class="block py-2 px-4 rounded-lg hover:bg-pink-700 mb-2">Applicants</a></li>
                        <li><a href="status.html" class="block py-2 px-4 rounded-lg hover:bg-pink-700 mb-2">Status</a></li>
                    </ul>
                </nav>
            </div>

            <!-- Logout Button -->
            <div class="mt-auto">
                <button onclick="logoutUser()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 mt-4">
                    Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8 overflow-auto">

            <!-- Interview Scheduler -->
            <div class="mb-8">
                <label for="applicantSelect" class="block text-gray-700">Select Applicant</label>
                <select id="applicantSelect" class="mt-2 block w-full bg-white border border-gray-300 rounded-lg p-2">
                    <!-- Applicants will be dynamically populated here -->
                </select>
            </div>

            <div class="mb-8">
                <h3 class="text-xl font-semibold">Schedule an Interview</h3>
                <p class="text-gray-600">Click on a date on the calendar to schedule an interview with the selected applicant.</p>
            </div>

            <!-- Calendar -->
            <div id="calendar"></div>

        </div>
    </div>

</body>
</html>

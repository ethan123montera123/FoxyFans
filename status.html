<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex min-h-screen bg-white">

    <!-- Sidebar -->
    <div class="bg-pink-600 w-full md:w-64 p-4 text-white flex flex-col justify-between">
        <div>
            <h2 class="text-2xl font-semibold mb-6">FoxyFans Dashboard</h2>
            <nav>
                <ul>
                    <!-- <li>
                        <a href="dashboard.html" id="homeLink" class="block py-2 px-4 rounded-lg hover:bg-pink-700 mb-2">Home</a>
                    </li> -->
                    <li>
                        <a href="applicants.html" id="applicantsLink" class="block py-2 px-4 rounded-lg hover:bg-pink-700 mb-2">Applicants</a>
                    </li>
                    <li>
                        <a href="status.html" id="statusLink" class="block py-2 px-4 rounded-lg hover:bg-pink-700 mb-2" aria-current="page">Status</a>
                    </li>
                </ul>
            </nav>
        </div>
        <div class="mt-auto">
            <button onclick="logoutUser()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 mt-4">
                Logout
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 p-8 bg-gray-100">
        <!-- Container for Status Table -->
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-4xl mt-16 mb-16 mx-auto">
            <h1 class="text-3xl font-semibold text-center text-pink-600 mb-6">Application Status</h1>

            <!-- Table to display client applications -->
            <table class="min-w-full table-auto border-collapse">
                <thead>
                    <tr class="bg-pink-600 text-white">
                        <th class="py-3 px-4 text-left">Full Name</th>
                        <th class="py-3 px-4 text-left">Status</th>
                    </tr>
                </thead>
                <tbody id="statusTable" class="text-gray-700">
                    <!-- Dynamically populated rows will go here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Viewing Applicant Details -->
    <div id="applicantModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-96">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Applicant Details</h2>
            <div id="applicantDetails" class="space-y-4 text-gray-700">
                <!-- Applicant details will be populated here -->
            </div>
            <div class="flex justify-end mt-4">
                <button onclick="closeModal()" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700">Close</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase dependencies
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, update, onValue } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBQv0xhSZS0Sv--8ohXsrtME_HLlVTOeLg",
            authDomain: "foxyfans-e9761.firebaseapp.com",
            databaseURL: "https://foxyfans-e9761-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "foxyfans-e9761",
            storageBucket: "foxyfans-e9761.firebasestorage.app",
            messagingSenderId: "509215295074",
            appId: "1:509215295074:web:2bb6485985db4b99e2333b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Add active class dynamically based on the current page
        const currentPage = window.location.pathname;
        if (currentPage.includes("dashboard.html")) {
            document.getElementById("homeLink").classList.add("bg-pink-700");
        } else if (currentPage.includes("applicants.html")) {
            document.getElementById("applicantsLink").classList.add("bg-pink-700");
        } else if (currentPage.includes("status.html")) {
            document.getElementById("statusLink").classList.add("bg-pink-700");
        }

        // Logout function
        window.logoutUser = async function() {
            try {
                await signOut(auth);
                alert("You have been logged out.");
                window.location.href = "login.html"; // Redirect to login page after logout
            } catch (error) {
                console.error("Error signing out: ", error);
            }
        }

        // Authentication check to ensure the user is logged in
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // If no user is logged in, redirect to login page
                window.location.href = "login.html";
            }
        });

        // Reference to the database
        const applicationsRef = ref(database, 'applications');

        // Fetch applications data from Firebase and update the table
        onValue(applicationsRef, (snapshot) => {
            const statusTable = document.getElementById('statusTable');
            statusTable.innerHTML = ''; // Clear previous data

            // Check if data exists
            const data = snapshot.val();
            if (data) {
                // Iterate through each application and add a row to the table
                Object.keys(data).forEach((key) => {
                    const application = data[key];

                    // Create table row for each application
                    const row = document.createElement('tr');
                    row.classList.add('border-t', 'border-gray-300');

                    // Full name cell
                    const nameCell = document.createElement('td');
                    nameCell.classList.add('py-3', 'px-4');
                    nameCell.textContent = application.name;

                    // Status cell (Dropdown)
                    const statusCell = document.createElement('td');
                    statusCell.classList.add('py-3', 'px-4');

                    // Create status dropdown
                    const statusDropdown = document.createElement('select');
                    statusDropdown.classList.add('bg-gray-100', 'px-4', 'py-2', 'rounded-lg');
                    const statuses = ['Processing', 'For Interview', 'Accepted'];

                    statuses.forEach((status) => {
                        const option = document.createElement('option');
                        option.value = status;
                        option.textContent = status;
                        if (application.status === status) {
                            option.selected = true;
                        }
                        statusDropdown.appendChild(option);
                    });

                    // Handle status change
                    statusDropdown.addEventListener('change', (event) => {
                        const newStatus = event.target.value;
                        // Update the status in the database
                        update(ref(database, 'applications/' + key), {
                            status: newStatus
                        }).then(() => {
                            console.log("Status updated successfully!");
                        }).catch((error) => {
                            console.error("Error updating status:", error);
                        });
                    });

                    // Append dropdown to status cell
                    statusCell.appendChild(statusDropdown);

                    // Append cells to the row
                    row.appendChild(nameCell);
                    row.appendChild(statusCell);

                    // Append row to the table
                    statusTable.appendChild(row);
                });
            } else {
                // If no data exists, show a message
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 2;
                cell.classList.add('py-3', 'px-4', 'text-center', 'text-gray-500');
                cell.textContent = 'No applications found.';
                row.appendChild(cell);
                statusTable.appendChild(row);
            }
        });

        // Function to open modal and populate applicant data
        function openModal(applicantId) {
            const modal = document.getElementById('applicantModal');
            const detailsContainer = document.getElementById('applicantDetails');
            detailsContainer.innerHTML = ''; // Clear previous details

            // Fetch applicant details from Firebase
            const applicantRef = ref(database, 'applications/' + applicantId);
            onValue(applicantRef, (snapshot) => {
                const applicant = snapshot.val();
                if (applicant) {
                    // Populate modal with applicant details
                    const details = `
                        <p><strong>Name:</strong> ${applicant.name}</p>
                        <p><strong>Location:</strong> ${applicant.location}</p>
                        <p><strong>Age:</strong> ${applicant.age}</p>
                        <p><strong>Work Experience:</strong> ${applicant.workExperience}</p>
                        <p><strong>Last Job's Performance:</strong> ${applicant.lastJobPerformance}</p>
                        <p><strong>Work Issues:</strong> ${applicant.workIssues}</p>
                        <p><strong>Typing Test:</strong> ${applicant.typingTest}</p>
                        <p><strong>Proof of Logouts:</strong> ${applicant.proofOfLogouts}</p>
                        <p><strong>Telegram Username:</strong> ${applicant.telegramUsername}</p>
                    `;
                    detailsContainer.innerHTML = details;
                    modal.classList.remove('hidden'); // Show the modal
                }
            });
        }

        // Function to close the modal
        function closeModal() {
            const modal = document.getElementById('applicantModal');
            modal.classList.add('hidden'); // Hide the modal
        }
    </script>

</body>
</html>
